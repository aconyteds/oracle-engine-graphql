// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-arm64-openssl-1.1.x", "debian-openssl-3.0.x", "debian-openssl-1.1.x"]
}

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

// System data

model User {
  id              String     @id @default(auto()) @map("_id") @db.ObjectId
  googleAccountId String     @unique
  email           String?    @unique
  name            String?
  threads         Thread[]
  createdAt       DateTime   @default(now())
  updatedAt       DateTime   @updatedAt
  // This indicates that the user is authorized to use the tool
  active          Boolean    @default(false)
  // The last campaign the user loaded
  lastCampaignId  String?    @db.ObjectId // Stores the last loaded campaign
  Campaign        Campaign[] // One-to-many relationship with Campaign
}

model Thread {
  id         String    @id @default(auto()) @map("_id") @db.ObjectId
  title      String
  messages   Message[]
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
  user       User      @relation(fields: [userId], references: [id])
  userId     String    @db.ObjectId
  campaign   Campaign  @relation(fields: [campaignId], references: [id])
  campaignId String    @db.ObjectId
}

// This is a type to manage all of the events that the AI took when generating a message.
// This will keep track of reasoning, chain of though, tool calls, and tool results
type MessageWorkspace {
  // The type of event that occurred
  messageType String
  // The data associated with the event
  content     String
  // The timestamp when the event occurred
  timestamp   DateTime @default(now())
  // The elapsed time, if available
  elapsedTime Float?
}

model Message {
  id              String             @id @default(auto()) @map("_id") @db.ObjectId
  role            String
  tokenCount      Int
  content         String
  workspace       MessageWorkspace[]
  thread          Thread             @relation(fields: [threadId], references: [id])
  threadId        String             @db.ObjectId
  createdAt       DateTime           @default(now())
  updatedAt       DateTime           @updatedAt
  runId           String? // UUID to trace the LLM call in LangSmith
  routingMetadata Json? // Store routing decision and performance data per message
}

// RPG data

model Campaign {
  id            String          @id @default(auto()) @map("_id") @db.ObjectId
  ownerId       String          @db.ObjectId
  name          String
  setting       String
  tone          String
  ruleset       String
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt
  CampaignAsset CampaignAsset[]
  SessionEvent  SessionEvent[]
  threads       Thread[]
  user          User            @relation(fields: [ownerId], references: [id])

  @@unique([ownerId, name])
  @@index([ownerId])
}

enum RecordType {
  NPC
  Location
  Plot
}

model CampaignAsset {
  id               String         @id @default(auto()) @map("_id") @db.ObjectId
  campaignId       String         @db.ObjectId
  campaign         Campaign       @relation(fields: [campaignId], references: [id])
  name             String
  recordType       RecordType
  summary          String? // Used for Quick linking to populate popover text for the Asset
  playerSummary    String? // Used for player friendly quick linking to populate popover text using only player knowledge
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt
  Embeddings       Float[] // Used for Vector Search
  locationData     LocationData?
  plotData         Plot?
  npcData          NPC?
  sessionEventLink String[]       @default([]) @db.ObjectId // Links to SessionEvent IDs
  sessionEventData SessionEvent[] @relation(fields: [sessionEventLink], references: [id])

  @@index([name])
  @@index([sessionEventLink])
  @@index([campaignId, recordType])
}

type LocationData {
  imageUrl          String?
  description       String
  condition         String
  pointsOfInterest  String
  characters        String
  dmNotes           String
  sharedWithPlayers String
}

enum PlotStatus {
  Unknown
  Rumored
  InProgress
  WillNotDo
  Closed
}

enum Urgency {
  Ongoing
  TimeSensitive
  Critical
  Resolved
}

type Plot {
  dmNotes           String
  sharedWithPlayers String
  status            PlotStatus
  urgency           Urgency
}

type NPC {
  imageUrl            String?
  physicalDescription String
  motivation          String
  mannerisms          String
  dmNotes             String
  sharedWithPlayers   String
}

model SessionEvent {
  id               String          @id @default(auto()) @map("_id") @db.ObjectId
  campaignId       String          @db.ObjectId
  campaign         Campaign        @relation(fields: [campaignId], references: [id])
  summary          String
  relatedAssetList String[]        @default([]) @db.ObjectId // IDs of related Campaign Assets (many-to-many via array)
  campaignAssets   CampaignAsset[] @relation(fields: [relatedAssetList], references: [id])
  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @updatedAt

  @@index([campaignId])
  @@index([relatedAssetList])
}

model SearchMetric {
  id         String   @id @default(auto()) @map("_id") @db.ObjectId
  createdAt  DateTime @default(now())
  searchType String // e.g., "campaign_asset_search"

  campaignId       String  @db.ObjectId
  hasResults       Boolean
  resultCount      Int
  requestedLimit   Int
  minScore         Float
  executionTimeMs  Float
  embeddingTimeMs  Float
  vectorTimeMs     Float
  conversionTimeMs Float
  query            String
  queryLength      Int

  precisionAtK   Float?
  recallAtK      Float?
  f1AtK          Float?
  precisionAt200 Float?
  recallAt200    Float?
  f1At200        Float?
  coverageRatio  Float?

  scoreMean   Float?
  scoreMedian Float?
  scoreMin    Float?
  scoreMax    Float?
  scoreStdDev Float?

  totalAssets Int?

  sampled Boolean @default(false)

  @@index([searchType])
  @@index([campaignId])
  @@index([sampled])
}

model RoutingMetric {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  createdAt DateTime @default(now())

  // Context identifiers (from config.context)
  userId     String @db.ObjectId
  campaignId String @db.ObjectId
  threadId   String @db.ObjectId
  runId      String // LangSmith trace ID

  // Basic metrics (always saved)
  analysisTimeMs Float
  messageCount   Int
  topicStability Float

  // Agent information
  currentAgent    String // Agent that invoked the tool
  availableAgents String[] // Names of sub-agents available

  // Topic analysis
  dominantTopics  String[]
  topicShiftCount Int

  // Detailed analysis (always saved - no sampling)
  agentPerformanceJson  Json // Detailed agent performance breakdown
  patternsJson          Json // Detected conversation patterns
  topicShiftsJson       Json // Detailed topic shift analysis
  continuityFactorsJson Json // Continuity factors
  recommendationsJson   Json // Generated recommendations

  @@index([userId])
  @@index([campaignId])
  @@index([threadId])
  @@index([runId])
  @@index([currentAgent])
}

// LangGraph Checkpoint Storage
model Checkpoint {
  id                  String   @id @map("_id") // LangGraph UUID (not MongoDB ObjectId)
  threadId            String // Composite: "userId:threadId:campaignId"
  checkpointNamespace String   @default("") // Checkpoint namespace
  checkpointData      Json // Serialized LangGraph checkpoint
  metadata            Json // Additional metadata (runId, agentName, step, writes)
  parentCheckpointId  String? // Parent checkpoint UUID
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
  // There is a TTL index as well, but Prisma doesn't support TTL indexes
  // This is created in a script: srcipts/atlas-indexes/standardIndexDefinitions.ts
  // Prisma push will remove the index, so the script must be re-run after any prisma changes
  // @@index([createdAt], map: "Checkpoint_createdAt_idx", type: TTL, expireAfterSeconds: 1_209_600) // 14 days

  @@index([threadId, checkpointNamespace])
}

// Rule data - Post MVP

// enum RuleType {
//   Core
//   Supplemental
//   Homebrew
// }

// enum RuleCategory {
//   CharacterCreation
//   Combat
//   Exploration
//   Magic
//   Social
//   Crafting
//   Downtime
//   GMTools
// }

// enum GameSystem {
//   DnD5e
//   WorldOfDarkness
// }

// model Rule {
//   id           String       @id @default(auto()) @map("_id") @db.ObjectId
//   // The content chunk for this rule
//   content      String
//   createdAt    DateTime     @default(now())
//   updatedAt    DateTime     @updatedAt
//   ruleType     RuleType
//   ruleCategory RuleCategory
//   gameSystem   GameSystem
//   // Includes details of where the rule is from, page it can be found on, etc.
//   metadata     Json?
//   embeddings   Float[] // Used for Vector Search

//   // Used for filtering and searching
//   @@index([ruleType])
//   @@index([ruleCategory])
//   @@index([gameSystem])
// }
